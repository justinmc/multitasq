var Multitasq=function(){function t(){this.sandbox=new t.Sandbox(this),this.router=new t.Router(this),Backbone.history.start({pushState:!1}),this.createEvents()}return t.Router=null,t.Sandbox=null,t.TaskView=null,t.TaskList=null,t.Task=null,t.prototype.sandbox=null,t.prototype.helpShown=!1,t.prototype.createEvents=function(){var t=this;$(".helpToggle").on("click",function(e){t.helpShown?t.router.navigate("",{trigger:!0}):t.router.navigate("help",{trigger:!0}),e.preventDefault()})},t.prototype.helpShow=function(){this.sandbox.clear(),$("#content_tasksvg").hide(),$("#content_overlay").show(),this.helpShown=!0},t.prototype.helpHide=function(){this.sandbox.render(),$("#content_tasksvg").show(),$("#content_overlay").hide(),this.helpShown=!1},t}();
Multitasq.Task=Backbone.Model.extend({defaultTitle:"New Task",defaults:function(){var t=Date.now();return{kind:"tasks#task",id:"0",etag:"0",title:this.defaultTitle,updated:t,selfLink:"0",parent:-1,position:"0",status:"needsAction",completed:null,created:t,description:"",children:[],level:0,minimized:!1,upped:!1}},initialize:function(){this.get("title")||(this.set({title:this.defaults.title}),this.set({title:this.defaults.parent})),this.bind("change",this.update)},update:function(){this.save({updated:Date.now()},{silent:!0})},toggleMinimized:function(){this.save(this.get("minimized")===!1?{minimized:!0}:{minimized:!1})},toggleUpdown:function(){this.save(this.get("upped")===!1?{upped:!0}:{upped:!1})},toggleCompleted:function(){null===this.get("completed")?this.setCompleted():this.setIncomplete()},setCompleted:function(){var t=Date.now();this.save({completed:t}),this.save({updated:t})},setIncomplete:function(){var t=Date.now();this.save({completed:null}),this.save({updated:t})},dateToGoogleTasks:function(t){return t=t.getUTCFullYear()+"-"+t.getUTCMonth()+"-"+t.getUTCDate()+"T"+t.getUTCHours()+":"+t.getUTCMinutes()+":"+t.getUTCSeconds()+".000Z"},getCreatedHuman:function(){return this.dateToHuman(this.get("created"))},getUpdatedHuman:function(){return this.dateToHuman(this.get("updated"))},dateToHuman:function(t){var e=new Date(t);return"[object Date]"===Object.prototype.toString.call(e)&&isNaN(e.valueOf())?"":e.toLocaleTimeString()+" "+e.toLocaleDateString()},clear:function(){this.destroy()}});
Multitasq.TaskList=Backbone.Collection.extend({model:Multitasq.Task,localStorage:new Backbone.LocalStorage("multitasq-backbone"),top:null,initialize:function(e){this.bind("reset",function(){this.collectionUpdated(e)}),this.bind("add",function(){this.collectionUpdated(e)}),this.bind("remove",function(e){var t=this.get(e.get("parent"));if("undefined"!=typeof t){var i=t.get("children");i.splice($.inArray(e.get("id"),i),1),t.save({children:i})}Backbone.sync("delete",e,{success:function(){},error:function(){}})})},collectionUpdated:function(e){this.top=null,this.length||this.create({id:this.newId(),title:"Conquer the world"});var t=this,i=[];if(this.each(function(e){var n=t.get(e.get("parent")),r="undefined"==typeof n||-1===n?0:n.get("level")+1;if(e.save({level:r}),("undefined"==typeof n||-1===n)&&i.push(e.get("id")),-1!==i.indexOf(e.get("id"))||e.get("upped")){var o=null===t.top?-1/0:t.get(t.top).get("level");e.get("level")>o&&(t.top=e.get("id"))}if("undefined"!=typeof n&&-1!==n){{var s=n.get("children");e.get("id")}-1===$.inArray(e.get("id"),s)&&(s.push(e.get("id")),n.save({children:s}))}}),i.length>1){var n=this.newId();for(var r in i)this.get(i[r]).save({parent:n});this.top=n,this.create({id:n,parent:-1,title:"Conquer the world"})}this.isValidTree()?e.render():(alert("Error: Invalid data in localstorage, click OK to clear"),localStorage.clear(),this.reset())},isValidTree:function(){var e=!0;null===this.top&&(e=!1);var t=this;return this.each(function(i){var n=i.get("children");for(var r in n)"undefined"==typeof t.get(n[r])&&(e=!1)}),e},newId:function(){for(var e=this.length?parseInt(this.get(this.at(this.length-1)).get("id")):0,t=e+1,i=!0;i;)this.get(t)||(i=!1),t++;return t},removeSubtree:function(e,t){this.removeSubtreeRecurse(e),this.collectionUpdated(t)},removeSubtreeRecurse:function(e){for(e.get("children");e.get("children").length;){var t=this.get(e.get("children")[0]);this.removeSubtreeRecurse(t)}this.remove(e)},setIncompleteSubtree:function(e){for(var t=e.get("children"),i=0;i<t.length;i++){var n=this.get(t[i]);this.setIncompleteSubtree(n)}e.setIncomplete()},setCompletedSubtree:function(e){for(var t=e.get("children"),i=0;i<t.length;i++){var n=this.get(t[i]);this.setCompletedSubtree(n)}e.setCompleted()},getAtLevel:function(e){var t=this,i=[];return this.each(function(n){t.getLevel(n)===e&&i.push(n)}),i},getParent:function(e){return this.get(e.get("parent"))},getLevel:function(e){return-1===e.get("parent")||"undefined"==typeof e.get("parent")?0:this.getLevel(this.getParent(e))+1},getHeight:function(e){var t=e.get("children");if(0===t.length||e.get("minimized")===!0)return 0;var i=0;for(var n in t){var r=this.getHeight(this.get(t[n]));r>i&&(i=r)}return i+1},getNearestCommonAncestor:function(e,t){var i=e.get("level"),n=t.get("level");return e.get("id")===t.get("id")?e:i!==n&&i>n?this.getNearestCommonAncestor(e,this.get(t.get("parent"))):this.getNearestCommonAncestor(this.get(e.get("parent")),this.get(t.get("parent")))}});
Multitasq.Sandbox=Backbone.View.extend({el:$("#content_tasksvg"),tasks:null,taskWidth:150,taskHeight:60,taskSpacing:20,taskLeftmost:1/0,taskRightmost:0,taskBottommost:0,taskTitleLength:18,scaleDownStep:.6,translation:0,mousestopTimer:null,colorActiveFill:"green",colorInactiveFill:"#ffffff",colorSelectedStroke:"green",colorUnselectedStroke:"#afafaf",nearest:-1,events:{mouseenter:"sandboxEnter",mouseleave:"sandboxLeave",mousemove:"updateTaskSelected","mouseenter #content_tasksvg_bg":"sandboxBgEnter","click #content_tasksvg_bg":"clickAdd","click .content_tasksvg_task_close":"clickRemove","click .content_tasksvg_task_minimize":"clickMinimize","click .content_tasksvg_task_updown":"clickUpdown","click .content_tasksvg_task_text":"clickReviveEdit","click .content_tasksvg_task_box":"clickReviveEdit","click .content_tasksvg_task_textfield_submit":"clickSubmit","mouseenter .content_tasksvg_task_box":"enterTask","mouseenter .content_tasksvg_task_close":"enterTask","mouseenter .content_tasksvg_task_text":"enterTask","submit .content_tasksvg_task_textfield_form":"clickSubmit",keyup:"keypress"},initialize:function(t){this.app=t,this.tasks=new Multitasq.TaskList(this),this.tasks.fetch(),this.tasks.length||this.tasks.reset();var s=this;this.listenTo(this.tasks,"change",function(){s.render()})},clear:function(){$(this.el).empty(),this.taskLeftmost=1/0,this.taskRightmost=0,this.taskBottommost=0;var t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("id","content_tasksvg_group"),$(this.el).append(t);var s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("id","content_tasksvg_bg"),s.setAttribute("width","100%"),s.setAttribute("height","100%"),$(t).append(s)},sandboxEnter:function(t){this.nearest=this.nearestTask(t.pageX,t.pageY-$(this.el).offset().top),this.setTaskSelected(this.nearest)},sandboxLeave:function(){$(".content_tasksvg_task_box").css("stroke","#afafaf"),$(".content_tasksvg_task_box").css("fill","#ffffff")},sandboxBgEnter:function(){this.setTaskInactive()},updateTaskSelected:function(t){if($("#content_tasksvg_bg:hover")){var s=$("#content").width(),e=$("#content").height(),a=this.getViewBoxWidth(),i=this.getViewBoxHeight(),n=t.pageX*a/s,o=(t.pageY-$(this.el).offset().top)*i/e,k=this.nearestTask(n,o);k!=this.nearest&&(this.setTaskSelected(k),this.nearest=k)}},clickAdd:function(){if($(".content_tasksvg_task_textfield").length)this.editTaskConfirmAll();else if(!this.tasks.get(this.nearest).get("minimized")){var t=this.tasks.newId();this.tasks.create({id:t,parent:this.nearest})}},clickRemove:function(t){var s=this.tasks.get($(t.target).parent().data("task"));s.get("completed")?this.tasks.removeSubtree(s,this):(this.tasks.setCompletedSubtree(s),this.tasks.collectionUpdated(this))},clickMinimize:function(t){var s=this.tasks.get($(t.target).parent().data("task"));s.get("children").length>0&&(s.toggleMinimized(),this.tasks.collectionUpdated(this))},clickUpdown:function(t){var s=this.tasks.get($(t.target).parent().data("task"));s.toggleUpdown(),this.tasks.collectionUpdated(this)},clickReviveEdit:function(t){var s=$(t.target).parent().data("task"),e=this.tasks.get(s);0!==e.get("level")&&this.tasks.get(e.get("parent")).get("completed")||(e.get("completed")?(this.tasks.setIncompleteSubtree(e),this.tasks.collectionUpdated(this)):($(".content_tasksvg_task_textfield").length&&this.editTaskConfirmAll(),this.editTask(s)))},clickSubmit:function(){return this.editTaskConfirmAll(),!1},enterTask:function(t){var s=$(t.target).data("id")?$(t.target).data("task"):$(t.target).parent().data("task");this.setTaskActive(s)},keypress:function(t){27===t.keyCode&&this.editTaskCancel()},editTask:function(t){var s=this.tasks.get(t);this.app.router.navigate("leaf/"+s.id,{trigger:!0})},editTaskCancel:function(){if($(".content_tasksvg_task_textfield").length){var t=this;$(".content_tasksvg_task_textfield").each(function(){var s=$(this).data("task"),e=$(".content_tasksvg_task_text.task"+s);e.get(0).textContent=t.tasks.get(s).get("title").substring(0,t.taskTitleLength)+"...",$(this).remove()})}},editTaskConfirmAll:function(){var t=this;$(".content_tasksvg_task_textfield").length&&$(".content_tasksvg_task_textfield").each(function(){var s=$(this).data("task"),e=$(this).find("input[type=text]"),a=t.tasks.get(s);$(this).remove(),a.save({title:$(e).val()})}),this.tasks.collectionUpdated(this)},setTaskActive:function(t){this.tasks.get(t);$(".content_tasksvg_task_box").css("fill",this.colorInactiveFill),$(".content_tasksvg_task_box.task"+t).css("fill",this.colorActiveFill)},setTaskInactive:function(t){var s="undefined"==typeof t?"":".task"+t;if($(".content_tasksvg_task_box"+s).css("fill","#ffffff"),$(".content_tasksvg_task_text"+s).text(a),"undefined"!=typeof t){var e=this.tasks.get(t),a=e.get("title").substring(0,this.taskTitleLength)+"...";$(".content_tasksvg_task_text"+s).text(a)}},setTaskSelected:function(t){$(".content_tasksvg_task_box").css("stroke",this.colorUnselectedStroke),$(".content_tasksvg_task_box.task"+t).css("stroke",this.colorSelectedStroke)},setTaskUnselected:function(t){var s="undefined"==typeof t?"":".task"+t;$(".content_tasksvg_task_box"+s).css("stroke",this.colorUnselectedStroke)},render:function(){var t=this;this.clear(),this.renderSubtree(this.tasks.top),this.bushifyTree(this.tasks.top);var s=this.getViewBoxWidth()*this.scaleDownStep,e=this.getViewBoxHeight()*this.scaleDownStep,a=this.taskRightmost-this.taskLeftmost,i=this.taskBottommost+2*this.taskSpacing;this.taskLeftmost<=0||this.taskRightmost>this.getViewBoxWidth()||i>this.getViewBoxHeight()?t.scale(1/this.scaleDownStep):s>a&&e>i&&this.taskWidth/s<.12&&t.scale(this.scaleDownStep)},renderSubtree:function(t){var s=this.tasks.get(t),e=new Multitasq.TaskView(s);if(e.render(this),!s.get("minimized")){var a=s.get("children");for(var i in a)this.renderSubtree(a[i]);if(!a.length){var n=parseInt($(".content_tasksvg_task_box.task"+t).attr("y"))+this.taskHeight;n>this.taskBottommost&&(this.taskBottommost=n)}}},bushifyTree:function(t){var s=$(".content_tasksvg_task.task"+t).data("children")||[],e={left:this.taskWidth/2+this.taskSpacing/2,right:this.taskWidth/2+this.taskSpacing/2};if(s.length>0){for(var a=[],i=0,n=0;n<s.length;n++){var o=this.bushifyTree(s[n]);a.push(o),i=i+o.left+o.right}e={left:i/2,right:i/2};var k=parseInt($(".content_tasksvg_task_box.task"+t).attr("x"))+this.taskWidth/2,r={left:k-e.left,right:k+e.right};if(r.left<this.taskLeftmost&&(this.taskLeftmost=r.left),r.right>this.taskRightmost&&(this.taskRightmost=r.right),s.length>1){var c=i/2*-1+this.taskWidth/2;for(n=0;n<s.length;n++){var h=c+a[n].left-this.taskWidth/2;this.translateTreeBy(s[n],h),c=c+a[n].left+a[n].right}}}return e},translateTreeBy:function(t,s){var e=$(".content_tasksvg_task.task"+t).data("children"),a=parseInt($(".content_tasksvg_task_box.task"+t).attr("x"));if(this.moveTaskTo(t,a+s),"undefined"!=typeof e)for(var i=0;i<e.length;i++)this.translateTreeBy(e[i],s)},scale:function(t){var s=this.getViewBoxWidth(),e=this.getViewBoxHeight();s=Math.round(s*t),e=Math.round(e*t),$(this.el)[0].setAttribute("viewBox","0 0 "+s+" "+e),this.render()},moveTaskTo:function(t,s){$(".content_tasksvg_task_box.task"+t).get(0).setAttribute("x",s),$(".content_tasksvg_task_text.task"+t).get(0).setAttribute("x",s+5),$(".content_tasksvg_task_close.task"+t).get(0).setAttribute("x",s+this.taskWidth-16),$(".content_tasksvg_task_updown.task"+t).get(0).setAttribute("x",s+this.taskWidth-54),$(".content_tasksvg_task_minimize.task"+t).get(0).setAttribute("x",s+this.taskWidth-32);var e=parseInt($(".content_tasksvg_task_box.task"+$(".content_tasksvg_task.task"+t).data("parent")).attr("x"));$(".content_tasksvg_connector.task"+t).get(0).setAttribute("x1",e+this.taskWidth/2),$(".content_tasksvg_connector.task"+t).get(0).setAttribute("x2",s+this.taskWidth/2),$(".content_tasksvg_task_textfield.task"+t).length&&$(".content_tasksvg_task_textfield.task"+t).get(0).setAttribute("x",s+5)},nearestTask:function(t,s){var e,a=1/0,i=this;return $(".content_tasksvg_task:not(.pending) > .content_tasksvg_task_box").each(function(){var n=i.nearestTaskPoint($(this).parent().data("task"),t,s),o=i.distance(n[0],n[1],t,s);a>o&&s>n[1]&&(a=o,e=$(this).parent().data("task"))}),"undefined"==typeof e&&(e=this.tasks.top),e},nearestTaskPoint:function(t,s,e){var a,i=$(".content_tasksvg_task_box.task"+t),n=parseInt($(i).attr("y")),o=parseInt($(i).attr("x"))+this.taskWidth,k=parseInt($(i).attr("y"))+this.taskHeight,r=parseInt($(i).attr("x"));a=r>s?r:s>o?o:s;var c;return c=n>e?n:e>k?k:e,[a,c]},getViewBoxWidth:function(){if(null===$(this.el)[0].getAttribute("viewBox"))return $("#content").width();var t=$(this.el)[0].getAttribute("viewBox");return t=t.substring(t.indexOf(" ")+1,t.length),t=t.substring(t.indexOf(" ")+1,t.length),parseInt(t.substring(0,t.indexOf(" ")))},getViewBoxHeight:function(){if(null===$(this.el)[0].getAttribute("viewBox"))return $("#content").height();var t=$(this.el)[0].getAttribute("viewBox");return t=t.substring(t.indexOf(" ")+1,t.length),t=t.substring(t.indexOf(" ")+1,t.length),parseInt(t.substring(t.indexOf(" ")+1,t.length))},getTaskMidX:function(t){return-1===t?0:parseInt($(".content_tasksvg_task_box.task"+t).attr("x"))+parseInt($(".content_tasksvg_task_box.task"+t).attr("width"))/2},getTaskMidBotY:function(t){return-1===t?0:parseInt($(".content_tasksvg_task_box.task"+t).attr("y"))+parseInt($(".content_tasksvg_task_box.task"+t).attr("height"))},getTaskMidTopY:function(t){return parseInt($(".content_tasksvg_task_box.task"+t).attr("y"))},distance:function(t,s,e,a){return Math.sqrt(Math.pow(t-e,2)+Math.pow(s-a,2))},removeClassSVG:function(t,s){var e=$(t).attr("class"),a=e.search(s);e=e.substring(0,a)+e.substring(a+s.length,e.length),$(t).attr("class",e)},hasClassSVG:function(t,s){var e=$(t).attr("class"),a=e.search(s);return-1===a?!1:!0}});
Multitasq.TaskView=Backbone.View.extend({el:null,task:null,events:{},initialize:function(t){this.task=t,this.el=$(".content_tasksvg_task.task"+t.get("id"))},render:function(t){var e=this.task.get("id"),s=this.task.get("parent"),a=this.task.get("dontSync")?!0:!1,i=this.task.get("title");i.length>t.taskTitleLength&&(i=i.substring(0,t.taskTitleLength-1),i+="...");var n=this.task.get("completed")?.3:1,r=t.getViewBoxWidth()/2-t.taskWidth/2,k=4,d=0;-1==s||this.task.get("upped")||(k=parseInt($(".content_tasksvg_task_box.task"+s).attr("y"))+100,d=parseInt(t.tasks.get(s).get("level"))+1);var g=document.createElementNS("http://www.w3.org/2000/svg","g"),c=a?" pending":"";g.setAttribute("class","content_tasksvg_task task"+e+c),g.setAttribute("style","opacity: "+n+";");var o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("class","content_tasksvg_task_box task"+e),o.setAttribute("x",r),o.setAttribute("y",k),o.setAttribute("rx","10"),o.setAttribute("ry","10"),o.setAttribute("width",t.taskWidth),o.setAttribute("height",t.taskHeight),g.appendChild(o);var u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("class","content_tasksvg_task_text task"+e),u.setAttribute("x",r+5),u.setAttribute("y",k+40);var h=document.createTextNode(i);if(u.appendChild(h),g.appendChild(u),-1!=s){var l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("class","content_tasksvg_task_updown task"+e),l.setAttribute("x",r+t.taskWidth-54),l.setAttribute("y",k+16),l.setAttribute("textLength",0);var p=document.createTextNode(this.task.get("id")==t.tasks.top?"↓":"↑");l.appendChild(p),g.appendChild(l)}var v=document.createElementNS("http://www.w3.org/2000/svg","text");v.setAttribute("class","content_tasksvg_task_minimize task"+e),v.setAttribute("x",r+t.taskWidth-36),v.setAttribute("y",k+16),v.setAttribute("textLength",0);var _=document.createTextNode(this.task.get("minimized")?"+":"-");v.appendChild(_),g.appendChild(v);var b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("class","content_tasksvg_task_close task"+e),b.setAttribute("x",r+t.taskWidth-16),b.setAttribute("y",k+16),b.setAttribute("textLength",20);var w=document.createTextNode("X");if(b.appendChild(w),g.appendChild(b),-1!=s&&!this.task.get("upped")){var A=document.createElementNS("http://www.w3.org/2000/svg","line");A.setAttribute("class","content_tasksvg_connector task"+s+" task"+e),A.setAttribute("x1",t.getTaskMidX(s)),A.setAttribute("y1",t.getTaskMidBotY(s)),A.setAttribute("x2",r+t.taskWidth/2),A.setAttribute("y2",k),g.appendChild(A)}$("#content_tasksvg_group").append(g),$(".content_tasksvg_task.task"+e).data("task",e),$(".content_tasksvg_task.task"+e).data("parent",s),$(".content_tasksvg_task.task"+e).data("children",this.task.get("minimized")?[]:this.task.get("children")),$(".content_tasksvg_task.task"+e).data("level",d)}});
Multitasq.Modal=Backbone.View.extend({template:_.template($("script.template-modal").html()),parentSelector:".modal-view",task:null,events:{"click .modal-background":"close","click .close":"close","keyup body":"keyup"},initialize:function(t){this.app=t.app,this.task=t.task;var e=this;this.listenTo(this.task,"change",function(){e.render()}),this.keyupBound=this.keyup.bind(this),$("body").on("keyup",this.keyupBound),this.render()},render:function(){return this.$el=$(this.template({title:this.task.get("title"),description:this.task.get("title"),created:this.task.getCreatedHuman(),updated:this.task.getUpdatedHuman()})),$(this.parentSelector).html(this.$el),this.editTitle=new Multitasq.EditableInput({task:this.task,attribute:"title",parentSelector:".editable-input.title"}),this.editDescription=new Multitasq.EditableInput({task:this.task,attribute:"description",parentSelector:".editable-input.description","long":!0}),this.task.get("title")===this.task.defaultTitle&&(this.editTitle.editing=!0,this.editTitle.render()),this.delegateEvents(),this},show:function(){},close:function(){$("body").off("keyup",this.keyupBound),this.app.router.navigate(""),this.remove()},keyup:function(t){(27===t.which||13===t.which)&&this.close()}});
Multitasq.EditableInput=Backbone.View.extend({template:_.template($("script.template-editable-input").html()),parentSelector:null,defaultValue:"Click to edit",editing:!1,events:{"click .editable":"edit","click .save":"save","click .cancel":"close","keyup .edit":"inputKeyup"},initialize:function(t){this.task=t.task,this.attribute=t.attribute,this.parentSelector=t.parentSelector,t.long&&(this.template=_.template($("script.template-editable-input-long").html())),this.render()},render:function(){var t=this.template({value:this.task.get(this.attribute),defaultValue:this.defaultValue,editing:this.editing});return this.$el=$(this.parentSelector).html(t),this.delegateEvents(),this.editing&&this.$el.find(".edit").get(0).select(),this},edit:function(){this.editing=!0,this.render()},close:function(){this.editing=!1,this.render()},save:function(){var t={};t[this.attribute]=this.$el.find(".edit").val(),this.task.save(t),this.close()},inputKeyup:function(t){27===t.which?(this.close(),t.stopPropagation()):13===t.which&&(this.save(),t.stopPropagation())}});
Multitasq.Router=Backbone.Router.extend({routes:{"":"main",help:"help","leaf/:id":"leaf","*path":"main"},initialize:function(t){this.app=t},main:function(){this.app.helpHide()},help:function(){this.app.helpShow()},leaf:function(t){new Multitasq.Modal({task:this.app.sandbox.tasks.get(t),app:this.app})}});
$(function(){window.multitasq=new Multitasq});