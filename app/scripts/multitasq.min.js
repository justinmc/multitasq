var Multitasq_Task=Backbone.Model.extend({defaultTitle:"New Task",defaults:function(){var t=this.getDateNow();return{kind:"tasks#task",id:"0",etag:"0",title:this.defaultTitle,updated:t,selfLink:"0",parent:-1,position:"0",status:"needsAction",completed:null,children:[],level:0,minimized:!1,upped:!1}},initialize:function(){this.get("title")||(this.set({title:this.defaults.title}),this.set({title:this.defaults.parent}))},toggleMinimized:function(){this.save(this.get("minimized")===!1?{minimized:!0}:{minimized:!1})},toggleUpdown:function(){this.save(this.get("upped")===!1?{upped:!0}:{upped:!1})},toggleCompleted:function(){null===this.get("completed")?this.setCompleted():this.setIncomplete()},setCompleted:function(){var t=this.getDateNow();this.save({completed:t}),this.save({updated:t})},setIncomplete:function(){var t=this.getDateNow();this.save({completed:null}),this.save({updated:t})},getDateNow:function(){var t=new Date,e=t.getUTCFullYear()+"-"+t.getUTCMonth()+"-"+t.getUTCDate()+"T"+t.getUTCHours()+":"+t.getUTCMinutes()+":"+t.getUTCSeconds()+".000Z";return e},clear:function(){this.destroy()}});
var Multitasq_TaskList=Backbone.Collection.extend({model:Multitasq_Task,localStorage:new Backbone.LocalStorage("multitasq-backbone"),top:null,initialize:function(e){this.bind("reset",function(){this.collectionUpdated(e)}),this.bind("add",function(){this.collectionUpdated(e)}),this.bind("remove",function(e){var t=this.get(e.get("parent"));if("undefined"!=typeof t){var i=t.get("children");i.splice($.inArray(e.get("id"),i),1),t.save({children:i})}Backbone.sync("delete",e,{success:function(){},error:function(){}})})},collectionUpdated:function(e){this.top=null,this.length||this.create({id:this.newId(),title:"Conquer the world"});var t=this,i=[];if(this.each(function(e){var n=t.get(e.get("parent")),r="undefined"==typeof n||-1===n?0:n.get("level")+1;if(e.save({level:r}),("undefined"==typeof n||-1===n)&&i.push(e.get("id")),-1!==i.indexOf(e.get("id"))||e.get("upped")){var o=null===t.top?-1/0:t.get(t.top).get("level");e.get("level")>o&&(t.top=e.get("id"))}if("undefined"!=typeof n&&-1!==n){{var s=n.get("children");e.get("id")}-1===$.inArray(e.get("id"),s)&&(s.push(e.get("id")),n.save({children:s}))}}),i.length>1){var n=this.newId();for(var r in i)this.get(i[r]).save({parent:n});this.top=n,this.create({id:n,parent:-1,title:"Conquer the world"})}this.isValidTree()?e.render():(alert("Error: Invalid data in localstorage, click OK to clear"),localStorage.clear(),this.reset())},isValidTree:function(){var e=!0;null===this.top&&(e=!1);var t=this;return this.each(function(i){var n=i.get("children");for(var r in n)"undefined"==typeof t.get(n[r])&&(e=!1)}),e},newId:function(){for(var e=this.length?parseInt(this.get(this.at(this.length-1)).get("id")):0,t=e+1,i=!0;i;)this.get(t)||(i=!1),t++;return t},removeSubtree:function(e,t){this.removeSubtreeRecurse(e),this.collectionUpdated(t)},removeSubtreeRecurse:function(e){for(e.get("children");e.get("children").length;){var t=this.get(e.get("children")[0]);this.removeSubtreeRecurse(t)}this.remove(e)},setIncompleteSubtree:function(e){for(var t=e.get("children"),i=0;i<t.length;i++){var n=this.get(t[i]);this.setIncompleteSubtree(n)}e.setIncomplete()},setCompletedSubtree:function(e){for(var t=e.get("children"),i=0;i<t.length;i++){var n=this.get(t[i]);this.setCompletedSubtree(n)}e.setCompleted()},getAtLevel:function(e){var t=this,i=[];return this.each(function(n){t.getLevel(n)===e&&i.push(n)}),i},getParent:function(e){return this.get(e.get("parent"))},getLevel:function(e){return-1===e.get("parent")||"undefined"==typeof e.get("parent")?0:this.getLevel(this.getParent(e))+1},getHeight:function(e){var t=e.get("children");if(0===t.length||e.get("minimized")===!0)return 0;var i=0;for(var n in t){var r=this.getHeight(this.get(t[n]));r>i&&(i=r)}return i+1},getNearestCommonAncestor:function(e,t){var i=e.get("level"),n=t.get("level");return e.get("id")===t.get("id")?e:i!==n&&i>n?this.getNearestCommonAncestor(e,this.get(t.get("parent"))):this.getNearestCommonAncestor(this.get(e.get("parent")),this.get(t.get("parent")))}});
var Multitasq_Sandbox=Backbone.View.extend({el:$("#content_tasksvg"),tasks:null,taskWidth:150,taskHeight:60,taskSpacing:20,taskLeftmost:1/0,taskRightmost:0,taskBottommost:0,taskTitleLength:18,scaleDownStep:.6,translation:0,mousestopTimer:null,colorActiveFill:"green",colorInactiveFill:"#ffffff",colorSelectedStroke:"green",colorUnselectedStroke:"#afafaf",nearest:-1,events:{mouseenter:"sandboxEnter",mouseleave:"sandboxLeave",mousemove:"updateTaskSelected","mouseenter #content_tasksvg_bg":"sandboxBgEnter","click #content_tasksvg_bg":"clickAdd","click .content_tasksvg_task_close":"clickRemove","click .content_tasksvg_task_minimize":"clickMinimize","click .content_tasksvg_task_updown":"clickUpdown","click .content_tasksvg_task_text":"clickReviveEdit","click .content_tasksvg_task_box":"clickReviveEdit","click .content_tasksvg_task_textfield_submit":"clickSubmit","mouseenter .content_tasksvg_task_box":"enterTask","mouseenter .content_tasksvg_task_close":"enterTask","mouseenter .content_tasksvg_task_text":"enterTask","submit .content_tasksvg_task_textfield_form":"clickSubmit",keyup:"keypress"},initialize:function(){this.tasks=new Multitasq_TaskList(this),this.tasks.fetch(),this.tasks.length||this.tasks.reset()},clear:function(){$(this.el).empty(),this.taskLeftmost=1/0,this.taskRightmost=0,this.taskBottommost=0;var t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("id","content_tasksvg_group"),$(this.el).append(t);var e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("id","content_tasksvg_bg"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),$(t).append(e)},sandboxEnter:function(t){this.nearest=this.nearestTask(t.pageX,t.pageY-$(this.el).offset().top),this.setTaskSelected(this.nearest)},sandboxLeave:function(){$(".content_tasksvg_task_box").css("stroke","#afafaf"),$(".content_tasksvg_task_box").css("fill","#ffffff")},sandboxBgEnter:function(){this.setTaskInactive()},updateTaskSelected:function(t){if($("#content_tasksvg_bg:hover")){var e=$("#content").width(),s=$("#content").height(),a=this.getViewBoxWidth(),i=this.getViewBoxHeight(),n=t.pageX*a/e,o=(t.pageY-$(this.el).offset().top)*i/s,k=this.nearestTask(n,o);k!=this.nearest&&(this.setTaskSelected(k),this.nearest=k)}},clickAdd:function(){if($(".content_tasksvg_task_textfield").length)this.editTaskConfirmAll();else if(!this.tasks.get(this.nearest).get("minimized")){var t=this.tasks.newId();this.tasks.create({id:t,parent:this.nearest}),this.editTask(t)}},clickRemove:function(t){var e=this.tasks.get($(t.target).parent().data("task"));e.get("completed")?this.tasks.removeSubtree(e,this):(this.tasks.setCompletedSubtree(e),this.tasks.collectionUpdated(this))},clickMinimize:function(t){var e=this.tasks.get($(t.target).parent().data("task"));e.get("children").length>0&&(e.toggleMinimized(),this.tasks.collectionUpdated(this))},clickUpdown:function(t){var e=this.tasks.get($(t.target).parent().data("task"));e.toggleUpdown(),this.tasks.collectionUpdated(this)},clickReviveEdit:function(t){var e=$(t.target).parent().data("task"),s=this.tasks.get(e);0!==s.get("level")&&this.tasks.get(s.get("parent")).get("completed")||(s.get("completed")?(this.tasks.setIncompleteSubtree(s),this.tasks.collectionUpdated(this)):($(".content_tasksvg_task_textfield").length&&this.editTaskConfirmAll(),this.editTask(e)))},clickSubmit:function(){return this.editTaskConfirmAll(),!1},enterTask:function(t){var e=$(t.target).data("id")?$(t.target).data("task"):$(t.target).parent().data("task");this.setTaskActive(e)},keypress:function(t){27===t.keyCode&&this.editTaskCancel()},editTask:function(t){var e=$(".content_tasksvg_task_text.task"+t),s=this.tasks.get(t);e.get(0).textContent="";var a=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");a.setAttribute("class","content_tasksvg_task_textfield task"+e.parent().data("task")),a.setAttribute("data-task",e.parent().data("task")),a.setAttribute("x",e.attr("x")),a.setAttribute("y",e.attr("y")-20),a.setAttribute("width",this.taskWidth-10),a.setAttribute("height","50");var i=document.createElement("body");i.setAttribute("xmlns","http://www.w3.org/1999/xhtml");var n=document.createElement("form");n.setAttribute("class","content_tasksvg_task_textfield_form");var o=document.createElement("input");o.setAttribute("type","text"),o.setAttribute("value",s.get("title")),o.setAttribute("style","width: "+(this.taskWidth-22)+"px");var k=document.createElement("input");k.setAttribute("type","submit"),k.setAttribute("value","Edit"),k.setAttribute("class","content_tasksvg_task_textfield_submit"),k.setAttribute("hidden","hidden"),n.appendChild(o),n.appendChild(k),i.appendChild(n),a.appendChild(i),$(this.el).append(a);var r=$(".content_tasksvg_task_textfield.task"+e.parent().data("task")).find("input[type=text]").get(0);r.select()},editTaskCancel:function(){if($(".content_tasksvg_task_textfield").length){var t=this;$(".content_tasksvg_task_textfield").each(function(){var e=$(this).data("task"),s=$(".content_tasksvg_task_text.task"+e);s.get(0).textContent=t.tasks.get(e).get("title").substring(0,t.taskTitleLength)+"...",$(this).remove()})}},editTaskConfirmAll:function(){var t=this;$(".content_tasksvg_task_textfield").length&&$(".content_tasksvg_task_textfield").each(function(){var e=$(this).data("task"),s=$(this).find("input[type=text]"),a=t.tasks.get(e);$(this).remove(),a.save({title:$(s).val()})}),this.tasks.collectionUpdated(this)},setTaskActive:function(t){this.tasks.get(t);$(".content_tasksvg_task_box").css("fill",this.colorInactiveFill),$(".content_tasksvg_task_box.task"+t).css("fill",this.colorActiveFill)},setTaskInactive:function(t){var e="undefined"==typeof t?"":".task"+t;if($(".content_tasksvg_task_box"+e).css("fill","#ffffff"),$(".content_tasksvg_task_text"+e).text(a),"undefined"!=typeof t){var s=this.tasks.get(t),a=s.get("title").substring(0,this.taskTitleLength)+"...";$(".content_tasksvg_task_text"+e).text(a)}},setTaskSelected:function(t){$(".content_tasksvg_task_box").css("stroke",this.colorUnselectedStroke),$(".content_tasksvg_task_box.task"+t).css("stroke",this.colorSelectedStroke)},setTaskUnselected:function(t){var e="undefined"==typeof t?"":".task"+t;$(".content_tasksvg_task_box"+e).css("stroke",this.colorUnselectedStroke)},render:function(){var t=this;this.clear(),this.renderSubtree(this.tasks.top),this.bushifyTree(this.tasks.top);var e=this.getViewBoxWidth()*this.scaleDownStep,s=this.getViewBoxHeight()*this.scaleDownStep,a=this.taskRightmost-this.taskLeftmost,i=this.taskBottommost+2*this.taskSpacing;this.taskLeftmost<=0||this.taskRightmost>this.getViewBoxWidth()||i>this.getViewBoxHeight()?t.scale(1/this.scaleDownStep):e>a&&s>i&&this.taskWidth/e<.12&&t.scale(this.scaleDownStep)},renderSubtree:function(t){var e=this.tasks.get(t),s=new Multitasq_TaskView(e);if(s.render(this),!e.get("minimized")){var a=e.get("children");for(var i in a)this.renderSubtree(a[i]);if(!a.length){var n=parseInt($(".content_tasksvg_task_box.task"+t).attr("y"))+this.taskHeight;n>this.taskBottommost&&(this.taskBottommost=n)}}},bushifyTree:function(t){var e=$(".content_tasksvg_task.task"+t).data("children")||[],s={left:this.taskWidth/2+this.taskSpacing/2,right:this.taskWidth/2+this.taskSpacing/2};if(e.length>0){for(var a=[],i=0,n=0;n<e.length;n++){var o=this.bushifyTree(e[n]);a.push(o),i=i+o.left+o.right}s={left:i/2,right:i/2};var k=parseInt($(".content_tasksvg_task_box.task"+t).attr("x"))+this.taskWidth/2,r={left:k-s.left,right:k+s.right};if(r.left<this.taskLeftmost&&(this.taskLeftmost=r.left),r.right>this.taskRightmost&&(this.taskRightmost=r.right),e.length>1){var c=i/2*-1+this.taskWidth/2;for(n=0;n<e.length;n++){var h=c+a[n].left-this.taskWidth/2;this.translateTreeBy(e[n],h),c=c+a[n].left+a[n].right}}}return s},translateTreeBy:function(t,e){var s=$(".content_tasksvg_task.task"+t).data("children"),a=parseInt($(".content_tasksvg_task_box.task"+t).attr("x"));if(this.moveTaskTo(t,a+e),"undefined"!=typeof s)for(var i=0;i<s.length;i++)this.translateTreeBy(s[i],e)},scale:function(t){var e=this.getViewBoxWidth(),s=this.getViewBoxHeight();e=Math.round(e*t),s=Math.round(s*t),$(this.el)[0].setAttribute("viewBox","0 0 "+e+" "+s),this.render()},moveTaskTo:function(t,e){$(".content_tasksvg_task_box.task"+t).get(0).setAttribute("x",e),$(".content_tasksvg_task_text.task"+t).get(0).setAttribute("x",e+5),$(".content_tasksvg_task_close.task"+t).get(0).setAttribute("x",e+this.taskWidth-16),$(".content_tasksvg_task_updown.task"+t).get(0).setAttribute("x",e+this.taskWidth-54),$(".content_tasksvg_task_minimize.task"+t).get(0).setAttribute("x",e+this.taskWidth-32);var s=parseInt($(".content_tasksvg_task_box.task"+$(".content_tasksvg_task.task"+t).data("parent")).attr("x"));$(".content_tasksvg_connector.task"+t).get(0).setAttribute("x1",s+this.taskWidth/2),$(".content_tasksvg_connector.task"+t).get(0).setAttribute("x2",e+this.taskWidth/2),$(".content_tasksvg_task_textfield.task"+t).length&&$(".content_tasksvg_task_textfield.task"+t).get(0).setAttribute("x",e+5)},nearestTask:function(t,e){var s,a=1/0,i=this;return $(".content_tasksvg_task:not(.pending) > .content_tasksvg_task_box").each(function(){var n=i.nearestTaskPoint($(this).parent().data("task"),t,e),o=i.distance(n[0],n[1],t,e);a>o&&e>n[1]&&(a=o,s=$(this).parent().data("task"))}),"undefined"==typeof s&&(s=this.tasks.top),s},nearestTaskPoint:function(t,e,s){var a,i=$(".content_tasksvg_task_box.task"+t),n=parseInt($(i).attr("y")),o=parseInt($(i).attr("x"))+this.taskWidth,k=parseInt($(i).attr("y"))+this.taskHeight,r=parseInt($(i).attr("x"));a=r>e?r:e>o?o:e;var c;return c=n>s?n:s>k?k:s,[a,c]},getViewBoxWidth:function(){if(null===$(this.el)[0].getAttribute("viewBox"))return $("#content").width();var t=$(this.el)[0].getAttribute("viewBox");return t=t.substring(t.indexOf(" ")+1,t.length),t=t.substring(t.indexOf(" ")+1,t.length),parseInt(t.substring(0,t.indexOf(" ")))},getViewBoxHeight:function(){if(null===$(this.el)[0].getAttribute("viewBox"))return $("#content").height();var t=$(this.el)[0].getAttribute("viewBox");return t=t.substring(t.indexOf(" ")+1,t.length),t=t.substring(t.indexOf(" ")+1,t.length),parseInt(t.substring(t.indexOf(" ")+1,t.length))},getTaskMidX:function(t){return-1===t?0:parseInt($(".content_tasksvg_task_box.task"+t).attr("x"))+parseInt($(".content_tasksvg_task_box.task"+t).attr("width"))/2},getTaskMidBotY:function(t){return-1===t?0:parseInt($(".content_tasksvg_task_box.task"+t).attr("y"))+parseInt($(".content_tasksvg_task_box.task"+t).attr("height"))},getTaskMidTopY:function(t){return parseInt($(".content_tasksvg_task_box.task"+t).attr("y"))},distance:function(t,e,s,a){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-a,2))},removeClassSVG:function(t,e){var s=$(t).attr("class"),a=s.search(e);s=s.substring(0,a)+s.substring(a+e.length,s.length),$(t).attr("class",s)},hasClassSVG:function(t,e){var s=$(t).attr("class"),a=s.search(e);return-1===a?!1:!0}});
var Multitasq_TaskView=Backbone.View.extend({el:null,task:null,events:{},initialize:function(t){this.task=t,this.el=$(".content_tasksvg_task.task"+t.get("id"))},render:function(t){var e=this.task.get("id"),s=this.task.get("parent"),a=this.task.get("dontSync")?!0:!1,i=this.task.get("title");i.length>t.taskTitleLength&&(i=i.substring(0,t.taskTitleLength-1),i+="...");var n=this.task.get("completed")?.3:1,r=t.getViewBoxWidth()/2-t.taskWidth/2,k=4,d=0;-1==s||this.task.get("upped")||(k=parseInt($(".content_tasksvg_task_box.task"+s).attr("y"))+100,d=parseInt(t.tasks.get(s).get("level"))+1);var g=document.createElementNS("http://www.w3.org/2000/svg","g"),c=a?" pending":"";g.setAttribute("class","content_tasksvg_task task"+e+c),g.setAttribute("style","opacity: "+n+";");var o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("class","content_tasksvg_task_box task"+e),o.setAttribute("x",r),o.setAttribute("y",k),o.setAttribute("rx","10"),o.setAttribute("ry","10"),o.setAttribute("width",t.taskWidth),o.setAttribute("height",t.taskHeight),g.appendChild(o);var u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("class","content_tasksvg_task_text task"+e),u.setAttribute("x",r+5),u.setAttribute("y",k+40);var h=document.createTextNode(i);if(u.appendChild(h),g.appendChild(u),-1!=s){var l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("class","content_tasksvg_task_updown task"+e),l.setAttribute("x",r+t.taskWidth-54),l.setAttribute("y",k+16),l.setAttribute("textLength",0);var p=document.createTextNode(this.task.get("id")==t.tasks.top?"↓":"↑");l.appendChild(p),g.appendChild(l)}var v=document.createElementNS("http://www.w3.org/2000/svg","text");v.setAttribute("class","content_tasksvg_task_minimize task"+e),v.setAttribute("x",r+t.taskWidth-36),v.setAttribute("y",k+16),v.setAttribute("textLength",0);var _=document.createTextNode(this.task.get("minimized")?"+":"-");v.appendChild(_),g.appendChild(v);var b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("class","content_tasksvg_task_close task"+e),b.setAttribute("x",r+t.taskWidth-16),b.setAttribute("y",k+16),b.setAttribute("textLength",20);var w=document.createTextNode("X");if(b.appendChild(w),g.appendChild(b),-1!=s&&!this.task.get("upped")){var A=document.createElementNS("http://www.w3.org/2000/svg","line");A.setAttribute("class","content_tasksvg_connector task"+s+" task"+e),A.setAttribute("x1",t.getTaskMidX(s)),A.setAttribute("y1",t.getTaskMidBotY(s)),A.setAttribute("x2",r+t.taskWidth/2),A.setAttribute("y2",k),g.appendChild(A)}$("#content_tasksvg_group").append(g),$(".content_tasksvg_task.task"+e).data("task",e),$(".content_tasksvg_task.task"+e).data("parent",s),$(".content_tasksvg_task.task"+e).data("children",this.task.get("minimized")?[]:this.task.get("children")),$(".content_tasksvg_task.task"+e).data("level",d)}});
$(function(){var n=new Multitasq_Sandbox;$(".helpToggle").on("click",function(){"block"==$("#content_overlay").css("display")?(n.render(),$("#content_tasksvg").show(),$("#content_overlay").hide()):(n.clear(),$("#content_tasksvg").hide(),$("#content_overlay").show())})});